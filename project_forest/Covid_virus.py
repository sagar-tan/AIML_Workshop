# -*- coding: utf-8 -*-
"""Untitled23.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/15AJEy2uzLrBiP2GntgwoaUFWvi1ixSPk
"""

from google.colab import files
uploaded = files.upload()

!pip install biopython

from google.colab import files
uploaded = files.upload()

from Bio import SeqIO

records = list(SeqIO.parse("sequences (2).fasta", "fasta"))
print("Total sequences:", len(records))
print("Example length:", len(records[0].seq))

!apt-get -qq install mafft

!mafft --auto "sequences (2).fasta" > aligned.fasta

from Bio import SeqIO

aligned = list(SeqIO.parse("aligned.fasta", "fasta"))

print("Aligned sequences:", len(aligned))
print("Aligned length:", len(aligned[0].seq))

from google.colab import files
uploaded = files.upload()

from Bio import SeqIO

ref = SeqIO.read("reference_genome.fasta", "fasta").seq
print("Reference length:", len(ref))

with open("combined.fasta", "w") as outfile:
    outfile.write(open("reference_genome.fasta").read())
    outfile.write(open("sequences (2).fasta").read())

!mafft --auto combined.fasta > combined_aligned.fasta

aligned = list(SeqIO.parse("combined_aligned.fasta", "fasta"))

print("Total aligned sequences:", len(aligned))

# Separate reference and samples
ref_aligned = aligned[0].seq
samples = aligned[1:]

mutation_data = []

for record in samples:
    seq = record.seq
    mutations = []

    for i in range(len(ref_aligned)):
        if ref_aligned[i] != seq[i] and seq[i] not in ["-", "N"]:
            mutations.append(f"{ref_aligned[i]}{i+1}{seq[i]}")

    mutation_data.append({
        "id": record.id,
        "mutations": mutations
    })

print("Number of mutations in first sample:", len(mutation_data[0]["mutations"]))
print("First 10 mutations:", mutation_data[0]["mutations"][:10])

for i, record in enumerate(aligned[:5]):
    print(i, record.id)

# Separate reference and samples properly

ref_aligned = None
samples = []

for record in aligned:
    if "NC_045512" in record.id and ref_aligned is None:
        ref_aligned = record.seq   # keep first reference only
    elif "NC_045512" not in record.id:
        samples.append(record)

print("Reference set:", ref_aligned is not None)
print("Number of samples:", len(samples))

mutation_data = []

for record in samples:
    seq = record.seq
    mutations = []

    for i in range(len(ref_aligned)):
        if ref_aligned[i] != seq[i] and seq[i] not in ["-", "N"]:
            mutations.append(f"{ref_aligned[i]}{i+1}{seq[i]}")

    mutation_data.append({
        "id": record.id,
        "mutations": mutations
    })

print("Number of mutations in first real sample:", len(mutation_data[0]["mutations"]))
print("First 10 mutations:", mutation_data[0]["mutations"][:10])

from collections import Counter

all_mutations = []

for sample in mutation_data:
    all_mutations.extend(sample["mutations"])

mutation_counts = Counter(all_mutations)

print("Top 10 most common mutations:")
for mut, count in mutation_counts.most_common(10):
    print(mut, ":", count)

import pandas as pd

# Get unique mutations
unique_mutations = sorted(set(all_mutations))

# Create empty dataframe
df = pd.DataFrame(0,
                  index=[sample["id"] for sample in mutation_data],
                  columns=unique_mutations)

# Fill 1 where mutation exists
for sample in mutation_data:
    for mut in sample["mutations"]:
        df.loc[sample["id"], mut] = 1

print("Shape of mutation matrix:", df.shape)
df.head()

from sklearn.decomposition import PCA
import matplotlib.pyplot as plt

pca = PCA(n_components=2)
X_pca = pca.fit_transform(df)

plt.figure(figsize=(6,5))
plt.scatter(X_pca[:,0], X_pca[:,1])
plt.xlabel("PC1")
plt.ylabel("PC2")
plt.title("PCA of SARS-CoV-2 Mutation Profiles")
plt.show()

from sklearn.cluster import KMeans
import matplotlib.pyplot as plt

kmeans = KMeans(n_clusters=3, random_state=42)
labels = kmeans.fit_predict(df)

plt.figure(figsize=(6,5))
plt.scatter(X_pca[:,0], X_pca[:,1], c=labels)
plt.xlabel("PC1")
plt.ylabel("PC2")
plt.title("Clustered SARS-CoV-2 Genomes")
plt.show()

print("Cluster counts:")
import numpy as np
print(np.bincount(labels))

import pandas as pd
import numpy as np

# Add cluster labels to dataframe
df_clustered = df.copy()
df_clustered["cluster"] = labels

signature_mutations = {}

for cluster in np.unique(labels):
    cluster_samples = df_clustered[df_clustered["cluster"] == cluster]

    # Mutation frequency inside cluster
    freq = cluster_samples.drop("cluster", axis=1).mean()

    # Keep mutations present in >80% of cluster
    sig = freq[freq > 0.8].index.tolist()

    signature_mutations[cluster] = sig[:10]  # top 10

for cluster, muts in signature_mutations.items():
    print(f"\nCluster {cluster} signature mutations:")
    print(muts)

def map_gene(position):
    if 266 <= position <= 21555:
        return "ORF1ab"
    elif 21563 <= position <= 25384:
        return "Spike"
    elif 25393 <= position <= 26220:
        return "ORF3a"
    elif 26245 <= position <= 26472:
        return "Envelope"
    elif 26523 <= position <= 27191:
        return "Membrane"
    elif 28274 <= position <= 29533:
        return "Nucleocapsid"
    else:
        return "Other"

for cluster, muts in signature_mutations.items():
    print(f"\nCluster {cluster} gene mapping:")
    for mut in muts[:5]:
        pos = int(mut[1:-1])
        print(mut, "→", map_gene(pos))

for record in aligned[:10]:
    print(record.description)

import re
import pandas as pd

metadata = []

for record in samples:
    desc = record.description

    # Extract 4-digit year
    match = re.search(r"(20\d{2})", desc)

    if match:
        year = int(match.group(1))
    else:
        year = None

    metadata.append({
        "id": record.id,
        "year": year
    })

metadata_df = pd.DataFrame(metadata)

metadata_df.head()

print(metadata_df["year"].value_counts())

df_time = df.copy()
df_time["year"] = metadata_df.set_index("id").loc[df.index]["year"]

df_filtered = df_time[df_time["year"].isin([2023, 2026])]

print(df_filtered["year"].value_counts())

mutation_shift = {}

for mut in unique_mutations:
    freq_2023 = df_filtered[df_filtered["year"] == 2023][mut].mean()
    freq_2026 = df_filtered[df_filtered["year"] == 2026][mut].mean()

    shift = freq_2026 - freq_2023
    mutation_shift[mut] = shift

# Sort by largest increase
emerging = sorted(mutation_shift.items(), key=lambda x: -x[1])

print("Top mutations increasing from 2023 → 2026:")
print(emerging[:10])

from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestClassifier
from sklearn.metrics import classification_report

X = df_filtered.drop("year", axis=1)
y = df_filtered["year"]

X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.3, random_state=42)

model = RandomForestClassifier(n_estimators=100)
model.fit(X_train, y_train)

y_pred = model.predict(X_test)

print(classification_report(y_test, y_pred))

# Add year to dataframe
df_time = df.copy()
df_time["year"] = metadata_df.set_index("id").loc[df.index]["year"]

# Calculate total mutation count per sample
df_time["mutation_count"] = df_time.drop("year", axis=1).sum(axis=1)

df_time.head()

# Filter valid years (>=2019)
df_time = df_time[df_time["year"] >= 2019]

# Optional: remove extreme mutation counts
df_time = df_time[df_time["mutation_count"] < 300]

mutation_per_year = df_time.groupby("year")["mutation_count"].mean()
print(mutation_per_year)

plt.figure(figsize=(7,5))

mutation_per_year.plot(kind="bar")

plt.xlabel("Year")
plt.ylabel("Average Mutation Count")
plt.title("Average Mutation Burden per Year")

plt.xticks(rotation=0)
plt.tight_layout()
plt.show()